# Telegram Monitoring[^1]

---

A bot that lets others know the foreground window/app on your computer and phone. It can also be used purely as an API (without Telegram features).

The server runs on Windows/macOS/Linux.

The client supports Windows 10/11 and Android 6.0+ only.

[中文文档](README_zh.md)

---

## Run

### Server

#### Using [uv](https://github.com/astral-sh/uv)

```bash
# Install dependencies
uv sync

# Run directly
uv run python -m telegram_monitoring

# Or run without bot, API-only
uv run python -m telegram_monitoring --nobot
```

#### Using system Python

```bash
# It's recommended to create a virtual environment first
python -m venv .venv
# Then activate it (Windows):
.venv\Scripts\activate
# Or (macOS/Linux):
source .venv/bin/activate

# Install dependencies
pip install -r requirements.txt
python -m telegram_monitoring

# Or run without bot, API-only
python -m telegram_monitoring --nobot
```

On first run, a `config.yaml` and API token will be created. The token is printed to the console.

If you believe the token has been leaked, run `python generate_token.py` to regenerate it (this automatically writes to `config.yaml`; activate your virtual environment and ensure dependencies are installed before running it).

---

### Client

#### Windows

Download the latest client from the project's Releases page. On first run it generates a config file; fill in the token and other fields according to your server config.

The client supports Windows 10/11 on x86 architecture only.

arm64 support on Windows is unknown. If you have an arm64 Windows machine, you can try running:

```bash
# Make sure uv is installed
uv sync --dev
uv run client.py
```

If arm64 has issues, please open an issue to report them.

#### Android (optional)

Install [MacroDroid](https://play.google.com/store/apps/details?id=com.arlosoft.macrodroid).

Download `monitoring.macro` from the Releases page and import it into MacroDroid.

You only need to modify all actions named `HTTP Request (POST)`.

- If you use a reverse proxy, you may change `http` to `https`.
- Replace `ip` with your server's IP or domain name.
- Replace `port` with the port you set in the server config (if you use port mapping, use the mapped port). It can be empty: simply remove `:port` (including the colon). Default ports are determined by the protocol: `http` is 80, `https` is 443.
- In request headers, set `your_token` to the token generated by the server.

Make the same changes to the remaining `HTTP Request (POST)` actions.

Finally, disable battery optimization for MacroDroid and keep it running in the background.

---

## Configuration

### Server

```yaml
bind: 0.0.0.0 # Listen address; default 0.0.0.0 listens on all interfaces
lang: zh_CN # Language; default zh_CN means Chinese
log_level: INFO # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL; default INFO
max_window: 5 # Maximum number of window titles to keep
port: 5000 # Listening port; default 5000
telegram: # Telegram-related settings; ignore if not used
  admins: # List of admin user IDs; empty list disables admin features
  - 123456789
  screenshot:
    allow: true # Whether screenshots are allowed; default true
    delete_time: 3 # Auto-delete time for screenshots in seconds; default 3
  token: "" # Telegram Bot token; required or the server will not start
token: "" # API token; auto-generated
```

### Client

```yaml
lang: zh_CN # Language; default zh-CN means Chinese
log_level: INFO # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL; default INFO
chat_mode: false # Whether to enable chat mode; default false
pass_window: # Window titles to filter; keep defaults if unsure
  - 任务切换
  - 新通知
server_url: http://localhost:5000 # Server URL; default http://localhost:5000; fill with your server's reachable IP/port
token: '' # API token; set to the token generated by the server
```

---

## Usage

### Telegram

#### Basic commands

- `/start` Register yourself in the database
- `/ping` Get the client's current foreground window and history, and the phone's current app and history
- `/screenshot` Capture and send a screenshot from the client (PC only)
- `/info` Get client hardware info (PC only)
- `/phone_info` Get phone info (phone only)
- `/ban` Ban a user
- `/unban` Unban a user
- `/add` Add an allowed user
- `/del` Remove an allowed user
- `/list` View registered users
- `/allowlist` View the allow list
- `/banlist` View the ban list

#### Feature demo

Activate the bot and fetch client window info:

![alt text](readme_src/PixPin_2025-11-29_16-07-16.gif)

Request a screenshot from the client:

![alt text](readme_src/PixPin_2025-11-29_16-10-01.gif)

Received client screenshots are treated as non-forwardable:

![alt text](readme_src/PixPin_2025-11-29_16-20-58.png)

If a notification naturally disappears or is moved to the control center, the current screen is considered disallowed for capture:

![alt text](readme_src/PixPin_2025-11-29_16-13-16.gif)

If a user is in the allow list, screens can be captured directly without explicit approval.

Get client hardware info:

![alt text](readme_src/PixPin_2025-11-29_16-17-41.gif)

Battery details: 0% is treated as a desktop or a laptop without a battery; charging status "Direct Power"; 95% and above is considered smart charging.

Get phone info:

![alt text](readme_src/PixPin_2025-11-29_16-33-18.gif)

Send a message to the client; the client can reply to the sender:

![alt text](readme_src/PixPin_2025-11-29_16-40-54.gif)

Flooding or triggering prohibited words will result in an immediate ban.

Chat mode:

![alt text](readme_src/PixPin_2025-11-29_16-44-33.gif)

### API

All APIs require authentication using the token from the config.

#### Socket.IO real-time

You can authenticate via the `auth` parameter, but you must additionally validate or pass a custom header `type` with value `listen_client` to connect, or use the query parameter `?type=listen_client`.

Python example:

```python
import socketio

sio = socketio.Client()
sio.connect(
  'http://localhost:5000',
  auth={'token': 'your_token', 'type': 'listen_client'}
)
```

Node.js example:

```javascript
const socket = io('http://localhost:5000', {
  auth: {
    token: 'your_token',
    type: 'listen_client'
  },
});
```

If you're not familiar with Socket.IO, use the HTTP API instead.

- Event: `get_window`
  Listen: yes
  Return value required: no
  Sample JSON:

  ```json
  {
    "now_window": "http://127.0.0.1:5000 - 1 - Azusa-mikan's Workspace",
    "switch_window_time": 1764411151,
    "window_list": [
        {
            "title": "http://127.0.0.1:5000 - 1 - Azusa-mikan's Workspace",
            "switch_window_time": 1764411075
        },
        {
            "title": "README_zh.md - telegram-monitoring - Trae",
            "switch_window_time": 1764411076
        },
        {
            "title": "http://127.0.0.1:5000 - 1 - Azusa-mikan's Workspace",
            "switch_window_time": 1764411077
        },
        {
            "title": "README_zh.md - telegram-monitoring - Trae",
            "switch_window_time": 1764411078
        },
        {
            "title": "http://127.0.0.1:5000 - 1 - Azusa-mikan's Workspace",
            "switch_window_time": 1764411151
        }
    ]
  }
  ```

- Event: `get_app`
  Listen: yes
  Return value required: no
  Sample JSON:

  ```json
  {
    "name": "哔哩哔哩",
    "status": "应用程序打开 (所有应用程序)",
    "battery": "73",
    "power_status": "未充电",
    "device_info": "Xiaomi MI 8 UD",
    "android_version": "10",
    "uptime": "130:31:14",
    "switch_app_time": 1764419892,
    "app_list": [
        [
            "系统桌面",
            1764419878
        ],
        [
            "哔哩哔哩",
            1764419892
        ]
    ]
  }
  ```

#### HTTP API

The request must have `Authorization: Bearer your_token` in headers; otherwise you will receive `401 Unauthorized`.

- `GET` `/now_window`
  Return type: `application/json`
  Sample JSON: same as above

- `GET` `/now_app`
  Return type: `application/json`
  Sample JSON: same as above

Note: `switch_window_time` and `switch_app_time` are Unix timestamps that you need to convert yourself.

### Technical details

#### Libraries used

##### Server

- [aiosqlite](https://github.com/omnilib/aiosqlite) — user storage
- [colorlog](https://github.com/borntyping/python-colorlog) — colored logs
- [pydantic](https://github.com/pydantic/pydantic) — config and JSON validation
- [pytelegrambotapi](https://github.com/eternnoir/pyTelegramBotAPI) — connects to Telegram
- [python-socketio](https://github.com/miguelgrinberg/python-socketio) — Server–Client architecture
- [pyyaml](https://github.com/yaml/pyyaml) — load configuration
- [fastapi](https://github.com/fastapi/fastapi) — provides the HTTP API
- [telegram-markdown-converter](https://github.com/ngoldo/telegram-markdown-converter) — escapes characters not accepted by MarkdownV2

##### Client

- [aiohttp](https://github.com/aio-libs/aiohttp) — required by `python-socketio[client]`
- [aiotools](https://github.com/achimnol/aiotools) — chat mode input helpers
- [mss](https://github.com/BoboTiG/python-mss) — screenshots
- [pillow](https://github.com/python-pillow/Pillow) — image processing
- [psutil](https://github.com/giampaolo/psutil) — system info
- [python-socketio[client]](https://github.com/miguelgrinberg/python-socketio) — pairs with `python-socketio`
- [pywin32](https://github.com/mhammond/pywin32) — foreground window title retrieval
- [win11toast](https://github.com/GitHub30/win11toast) — notifications

#### Project references

- [Prohibited words list](https://telegra.ph/%E8%BF%9D%E7%A6%81%E8%AF%8D%E5%88%97%E8%A1%A8-11-21) — from [ZGQ Inc.](https://github.com/ZGQ-inc)

---

## License

This project is licensed under [AGPL-3.0](LICENSE).

---

This project was previously vibe coding with GPT-4o (not public). It has now been completely rewritten and includes many extended features compared to the original.

[^1]: Name inspired by [DECO*27 - モニタリング](https://www.youtube.com/watch?v=kbNdx0yqbZE)
